binary_sensor:
  - platform: template
    sensors:
      # is computer at desk
      disrupted_mba_at_desk:
        friendly_name: "At Desk"
        device_class: presence
        value_template: "{{ is_state('device_tracker.disrupted_mba', 'home') and states('sensor.disrupted_mba_displays') | int > 1 or is_state('sensor.disrupted_mba_primary_display_name', 'DELL P2415Q') }}"

sensor:
  - platform: history_stats
    name: disrupted-MBP usage today
    entity_id: binary_sensor.disrupted_mbp_active
    state: "on"
    type: time
    start: "{{ now().replace(hour=8, minute=0, second=0) }}"
    # start: '{{ (as_timestamp(now().replace(hour=20, minute=0, second=0)) - 24 * 3600) }}'
    end: "{{ now() }}"
    # duration:
    #   hours: 16

automation:
  - alias: light desk computer
    trigger:
      - platform: state
        entity_id: binary_sensor.disrupted_mba_active
    condition:
      - condition: state
        entity_id: binary_sensor.disrupted_mba_at_desk
        state: "on"
      - condition: or
        conditions:
          - condition: state
            entity_id: sun.sun
            state: "below_horizon"
          - condition: state
            entity_id: light.desk_lamp
            state: "on"
    action:
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ trigger.from_state.state == 'off' }}"
              - condition: template
                value_template: "{{ trigger.to_state.state == 'on' }}"
              - condition: state
                entity_id: light.desk_lamp
                state: "off"
            sequence:
              - service: light.turn_on
                data:
                  entity_id: light.desk_lamp
          - conditions:
              - condition: template
                value_template: "{{ trigger.from_state.state == 'on' }}"
              - condition: template
                value_template: "{{ trigger.to_state.state == 'off' }}"
              - condition: state
                entity_id: light.desk_lamp
                state: "on"
            sequence:
              - service: light.turn_off
                data:
                  entity_id: light.desk_lamp
